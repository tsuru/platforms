#!/bin/bash -e

# Copyright 2015 tsuru authors. All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

SOURCE_DIR=/var/lib/tsuru
source ${SOURCE_DIR}/base/rc/config

export DEBIAN_FRONTEND=noninteractive

apt-get update

apt-get install -y --no-install-recommends \
        curl \
        libssl3 \
        zlib1g \
        libbz2-1.0 \
        libsqlite3-0 \
        libreadline8 \
        libexpat1 \
        make \
        build-essential \
        zstd

mkdir -p /app/.heroku
ln -s /home/application/python /app/.heroku/python

echo "export PATH=/home/application/python/bin:${PATH}" | tee -a ${HOME}/.profile /etc/profile >/dev/null
echo "/home/application/python/lib" | tee -a /etc/ld.so.conf.d/python.conf

# Fetch latest Python versions from python.org API and generate versions file
PYTHON_VERSIONS_FILE="${SOURCE_DIR}/python/latest_versions.sh"
mkdir -p "${SOURCE_DIR}/python"

echo "Fetching latest Python versions from python.org..."

# Fetch all releases from python.org API
RELEASES=$(curl -sS --retry 3 https://www.python.org/api/v2/downloads/release/)

# Extract versions, filter only Python 3.x releases, sort and get latest for each minor version
{
    echo "# Latest Python versions (auto-generated from python.org API)"
    echo "# Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
    echo ""

    # Process releases to extract versions
    echo "$RELEASES" | grep -oE '"name":"Python [0-9]+\.[0-9]+\.[0-9]+"' | \
        sed 's/"name":"Python \([0-9.]*\)"/\1/' | \
        grep -E '^3\.' | \
        sort -Vr | \
        awk -F'.' '!seen[$1"."$2]++ { printf("LATEST_%s%s=\"%s.%s.%s\"\n", $1, $2, $1, $2, $3) }'
} > "$PYTHON_VERSIONS_FILE"

# Ensure the file is readable
chmod 644 "$PYTHON_VERSIONS_FILE"

echo "Python versions file generated at: $PYTHON_VERSIONS_FILE"
cat "$PYTHON_VERSIONS_FILE"
