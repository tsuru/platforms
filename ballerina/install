#!/bin/bash -el

# Copyright 2025 tsuru authors. All rights reserved.
# Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.
set -eu -o pipefail

BALLERINA_VERSION=2201.13.1

# Detect architecture
ARCH=$(dpkg --print-architecture)

# Install Java 21 and unzip (required by Ballerina)
apt-get update
apt-get install -y --no-install-recommends openjdk-21-jdk-headless unzip
apt-get clean
rm -rf /var/lib/apt/lists/*

# Download and install Ballerina
curl -fsSL -o /tmp/ballerina.zip https://dist.ballerina.io/downloads/${BALLERINA_VERSION}/ballerina-${BALLERINA_VERSION}-swan-lake.zip
unzip -q /tmp/ballerina.zip -d /opt/
rm -f /tmp/ballerina.zip

# Create wrapper script for bal that sets JAVA_HOME
cat > /usr/local/bin/bal <<BAL_WRAPPER
#!/bin/bash
export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-${ARCH}
exec /opt/ballerina-${BALLERINA_VERSION}-swan-lake/bin/bal "\$@"
BAL_WRAPPER
chmod +x /usr/local/bin/bal

# Set JAVA_HOME environment variable for system-wide use
echo "export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-${ARCH}" >> /etc/environment
